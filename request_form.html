
<html>
    <head>
        <link rel="stylesheet" href="style.css">
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    </head>

    <body>
        <div class="row">
            <div class="column center" id="main_content">
                
                    <span class="label">Requestor (in-game name):</span><br/>
                    <input type="text" name="requestor_name" id="requestor_name"/><br/>
                    <br/>
                    <span class="label">Request type:</span><br/>
                    <select name="request_type" id="request_type">
                        <option value=""></option>
                        <option value="import">Import</option>
                        <option value="market_request">Market Request</option>
                        <option value="doctrine_ship">Doctrine Ship Order</option>
                    </select><br/>
                    <br/>
                    <div id="doctrine_ship_details" style="display: none;">
                        <span id="doctrine_fetching_message">Fetching price sheet...<br/></span>
                        <select name="doctrine_ships_select" id="doctrine_ships_select"></select><br/>
                        Amount:  <input type="text" name="doctrine_ships_amount" id="doctrine_ships_amount"/><br/>
                        Price: <span id="doctrine_ship_price">0</span> ISK</br>
                    </div>
                    <div id="import_details" style="display: none;">
                        <span class="label">Import details:</span><br/>
                        <textarea style="width:400px; height:200px; " placeholder="Enter list of items to be appraised.
example:

Tritanium 22222
Pyerite 8000" name="details" id="details"></textarea></br>
                    </div><br/>

                    <span class="label">Comment:</span><br/>
                    <input type="text" name="comment" id="comment"/><br/>

                    <br/>
                    <img src="loading.gif" style="display: none; width: 30px;" id="loading"/><br/>
                    <span style="color:orange; display: none;" id="captcha_ask">Please complete Captcha again.</br></span>
                    <input style="display: none;" type="Submit" id="submit" value="Submit Quote"/>
                    <input type="Submit" id="calculate" value="Calculate Quote"/><br/>
                    <span style="color:red; display: none;" id="captcha_error">Captcha Error!</br></span>
                    <span style="color:red; display: none;" id="general_error">Something went wrong Error!</br></span>
                    <span style="color:green; display: none;" id="general_success">Request Submited! Refresh the page to create a new one!</br></span>
                    <div class="g-recaptcha" data-sitekey="6Lf8D7kpAAAAAKWj_yht89iqHbvbUxFIaCPu_Sli"></div>
                    <i>All Import deliveries will be made to Sigga - Garden of Thorns. Contract price on delivery will be at <b>Jita +15%</b></i>
              
            </div>
        </div>

        <script>
            var pricesheeet = undefined;
            function GetPriceSheet() {
                pricesheeet = [];
                const url = "https://vorisaj.github.io/market/contracts.html";
                fetch(url)
                    .then(response => response.text())
                    .then(fetchedHTMLContent => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(fetchedHTMLContent, "text/html");
                        const tableRows = doc.querySelectorAll("table tr");

                        const headers = Array.from(tableRows[0].cells).map(cell => cell.textContent);

                        for(var i = 1; i < tableRows.length; i++) {
                            var entry = [];
                            var cells = tableRows[i].cells;
                            for(var j = 0; j<cells.length; j++) {
                                entry[headers[j]] = cells[j].textContent;
                            }
                            pricesheeet.push(entry);
                        }

                        $("#doctrine_fetching_message").remove();
                        for(var i = 0; i < pricesheeet.length; i++) {
                            $("#doctrine_ships_select").append('<option value="'+pricesheeet[i]["Contract Title"]+'">'+pricesheeet[i]["Contract Title"]+'</option>');
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching or parsing HTML:", error);
                    });
            }

            function ResetCaptcha() {
                grecaptcha.reset();
            }

            function RecalculateDoctrineShipPrice() {
                var selected = $("#doctrine_ships_select").val();
                for(var i = 0; i < pricesheeet.length; i++) {
                        if (pricesheeet[i]["Contract Title"] == selected) {
                            var price = parseInt(pricesheeet[i]["Contract Price"].replaceAll(",",""));
                            var amount = $("#doctrine_ships_amount").val();
                            if (isNaN(amount)) return;
                            $("#doctrine_ship_price").html((price*amount).toLocaleString('en'));
                            break;
                        }
                    }
            }

            $(document).ready(function(){
                GetPriceSheet();

                $('#doctrine_ships_select').on('change', function() {
                    RecalculateDoctrineShipPrice();
                });
                $('#doctrine_ships_amount').on('input', function() {
                    RecalculateDoctrineShipPrice();
                });

                $('#request_type').on('change', function() {
                    $("#calculate").hide();
                    $("#submit").hide();
                    if (this.value == "import") {
                        $("#calculate").show();
                        $("#import_details").show(); 
                    } else $("#import_details").hide();
                    if (this.value == "doctrine_ship") {
                         $("#submit").show();
                         $("#doctrine_ship_details").show();
                    } else $("#doctrine_ship_details").hide();
                });

                $("#submit").click("click",function() {
                    $(this).hide();
                    $("#doctrine_ship_details").hide();
                    $("#doctrine_ships_amount").hide();
                    $("#doctrine_ships_price").hide();
                    $("#request_type").hide();
                    $("#comment").hide();
                    $("#general_error").hide();
                    $("#loading").show();
                    $("#type").hide();
                    $("#details").hide();
                    $("#requestor_name").hide();
                    $(".label").hide();
                    $("#appraisal_table").remove();
                    $("#captcha_ask").hide();
                    $(".g-recaptcha").hide();
                    const type = $('#request_type').val();
                    var payload = {};
                    if (type == "import") payload = {"import_request":1,"g-recaptcha-response":$("#g-recaptcha-response").val()};
                    if (type == "doctrine_ship") payload = {"requestor":$("#requestor_name").val(),"ship_request":1,"comment":$("#comment").val(),"amount":$("#doctrine_ships_amount").val(),"fit":$("#doctrine_ships_select").val(),"g-recaptcha-response":$("#g-recaptcha-response").val()};
                    $.ajax({
                        type: "POST",
                        url: "https://market.baldhead.eu/kauihznaiuslamxjd.php",
                        data: payload,
                        xhrFields: {
                            withCredentials: true
                        },
                        success: (data) => {
                            $("#loading").hide();
                            data = JSON.parse(data);
                            if ("error" in data) {
                                $("#general_error").show();
                            } else {
                                $("#general_success").show();
                            }
                        }
                    });
                });

                $("#calculate").click("click",function() {
                    $(this).hide();
                    $("#request_type").hide();
                    $("#loading").show();
                    $("#type").hide();
                    $("#details").hide();
                    $(".label").hide();
                    $("#requestor_name").hide();
                    $("#comment").hide();
                    var request_data = $("#details").val();
                    $.ajax({
                        type: "POST",
                        xhrFields: {
                            withCredentials: true
                        },
                        url: "https://market.baldhead.eu/kauihznaiuslamxjd.php",
                        data: {"quote":1,"comment":$("#comment").val(), "input":$("#details").val(), "requestor_name":$("#requestor_name").val(), "request_type":$("#request_type").val(),"g-recaptcha-response":$("#g-recaptcha-response").val()},
                        success: (data) => {
                            data = JSON.parse(data);
                            $("#loading").hide();                            
                            if ("error" in data) {
                                $("#captcha_error").show();
                            } else {
                                //print summary
                                var appraisal_items = data["items"];
                                var items = "<table>";
                                for(var i = 0; i < appraisal_items.length; i++) {
                                    items += "<tr><td>"+appraisal_items[i]["amount"]+"x</td><td>"+appraisal_items[i]["itemType"]["name"]+"</td></tr>";
                                }
                                items += "</table>";
                                var table = "<table id='appraisal_table'>";
                                table += "<tr><td>Appraisal</td><td>https://janice.e-351.com/a/"+data["code"]+"</td></tr>";
                                table += "<tr><td>Total Volume:</td><td>"+data["totalPackagedVolume"]+" m3</td></tr>";
                                table += "<tr><td>Jita Price:</td><td>"+data["immediatePrices"]["totalSellPrice"]+" ISK</td></tr>";
                                table += "<tr><td>Final Price:</td><td><b>"+data["effectivePrices"]["totalSellPrice"]+" ISK</b></td></tr>";
                                table += "<tr><td>Final Items</td><td>"+items+"</td></tr>";
                                table += "</table>";
                                $('#main_content').prepend(table);
                                $("#submit").show();
                                ResetCaptcha();
                                $("#captcha_ask").show();
                            }
                        },

                        });

                    
                });

            });

        </script>
    </body>
</html>