
<html>
    <head>
        <link rel="stylesheet" href="style.css">
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    </head>

    <body>
        <div class="row">
            <div class="column center">
                
                    Requestor (in-game name):<br/>
                    <input type="text" name="requestor_name" id="requestor_name"/><br/>
                    <br/>
                    Request type:<br/>
                    <select name="request_type" id="request_type">
                        <option value=""></option>
                        <option value="import">Import</option>
                        <option value="market_request">Market Request</option>
                        <option value="doctrine_ship">Doctrine Ship Order</option>
                    </select><br/>
                    <br/>
                    <div id="doctrine_ship_details" style="display: none;">
                        <span id="doctrine_fetching_message">Fetching price sheet...<br/></span>
                        <select name="doctrine_ships_select" id="doctrine_ships_select"></select><br/>
                        Amount:  <input type="text" name="doctrine_ships_amount" id="doctrine_ships_amount"/><br/>
                        Price: <span id="doctrine_ship_price">0</span> ISK</br>
                    </div>
                    <div id="import_details" style="display: none;">
                        Import details:<br/>
                        <textarea style="width:400px; height:200px; " placeholder="Enter list of items to be appraised.
example:

Tritanium 22222
Pyerite 8000" name="details" id="details"></textarea></br>
                    </div><br/>

                    Comment:<br/>
                    <input type="text" name="comment" id="comment"/><br/>

                    <br/>
                    <img src="loading.gif" style="display: none; width: 30px;" id="loading"/><br/>
                    <input style="display: none;" type="Submit" id="submit" value="Submit Quote"/>
                    <input type="Submit" id="calculate" value="Calculate Quote"/><br/>
                    <span style="color:red; display: none;" id="captcha_error">Captcha Error!</br></span>
                    <span style="color:red; display: none;" id="general_error">Something went wrong Error!</br></span>
                    <span style="color:green; display: none;" id="general_success">Request Submited! Refresh the page to create a new one!</br></span>
                    <div class="g-recaptcha" data-sitekey="6Lf8D7kpAAAAAKWj_yht89iqHbvbUxFIaCPu_Sli"></div>
                    <i>All Import deliveries will be made to Sigga - Garden of Thorns. Contract price on delivery will be at <b>Jita +15%</b></i>
              
            </div>
        </div>

        <script>
            var pricesheeet = undefined;
            function GetPriceSheet() {
                pricesheeet = [];
                const url = "https://vorisaj.github.io/market/contracts.html";
                fetch(url)
                    .then(response => response.text())
                    .then(fetchedHTMLContent => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(fetchedHTMLContent, "text/html");
                        const tableRows = doc.querySelectorAll("table tr");

                        const headers = Array.from(tableRows[0].cells).map(cell => cell.textContent);

                        for(var i = 1; i < tableRows.length; i++) {
                            var entry = [];
                            var cells = tableRows[i].cells;
                            for(var j = 0; j<cells.length; j++) {
                                entry[headers[j]] = cells[j].textContent;
                            }
                            pricesheeet.push(entry);
                        }

                        $("#doctrine_fetching_message").remove();
                        for(var i = 0; i < pricesheeet.length; i++) {
                            $("#doctrine_ships_select").append('<option value="'+pricesheeet[i]["Contract Title"]+'">'+pricesheeet[i]["Contract Title"]+'</option>');
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching or parsing HTML:", error);
                    });
            }

            function RecalculateDoctrineShipPrice() {
                var selected = $("#doctrine_ships_select").val();
                for(var i = 0; i < pricesheeet.length; i++) {
                        if (pricesheeet[i]["Contract Title"] == selected) {
                            var price = parseInt(pricesheeet[i]["Contract Price"].replaceAll(",",""));
                            var amount = $("#doctrine_ships_amount").val();
                            if (isNaN(amount)) return;
                            $("#doctrine_ship_price").html((price*amount).toLocaleString('en'));
                            break;
                        }
                    }
            }

            $(document).ready(function(){
                GetPriceSheet();

                $('#doctrine_ships_select').on('change', function() {
                    RecalculateDoctrineShipPrice();
                });
                $('#doctrine_ships_amount').on('input', function() {
                    RecalculateDoctrineShipPrice();
                });

                $('#request_type').on('change', function() {
                    $("#calculate").hide();
                    $("#submit").hide();
                    if (this.value == "import") {
                        $("#calculate").show();
                        $("#import_details").show(); 
                    } else $("#import_details").hide();
                    if (this.value == "doctrine_ship") {
                         $("#submit").show();
                         $("#doctrine_ship_details").show();
                    } else $("#doctrine_ship_details").hide();
                });

                $("#submit").click("click",function() {
                    $(this).hide();
                    $("#loading").show();
                    const type = $('#request_type').val();
                    var payload = {};
                    if (type == "import") payload = {"import_request":1,"comment":$("#comment").val()};
                    if (type == "doctrine_ship") payload = {"ship_request":1,"comment":$("#comment").val(),"amount":$("#doctrine_ships_amount").val(),"fit":$("#doctrine_ships_select").val()};
                    $.ajax({
                        type: "POST",
                        url: "https://market.baldhead.eu/kauihznaiuslamxjd.php",
                        data: payload,
                        success: (data) => {
                            $("#loading").hide();
                            if ("error" in data) {
                                $("#general_error").show();
                            } else {
                                $("#general_success").show();
                            }
                        }
                    });
                });

                $("#calculate").click("click",function() {
                    $(this).hide();
                    $("#loading").show();
                    $("#type").hide();
                    $("#details").hide();
                    $("#requestor_name").hide();
                    var request_data = $("#details").val();
                    $.ajax({
                        type: "POST",
                        url: "https://market.baldhead.eu/kauihznaiuslamxjd.php",
                        data: {"quote":1, "input":$("#details").val(), "requestor_name":$("#requestor_name").val(), "request_type":$("#request_type").val(),"g-recaptcha-response":$("#g-recaptcha-response").val()},
                        success: (data) => {
                            data = JSON.parse(data);
                            console.log(data);
                            $("#loading").hide();
                            
                            if ("error" in data) {
                                $("#captcha_error").show();
                            } else {
                                
                                $("#submit").show();
                            }
                        },

                        });

                    
                });

            });

        </script>
    </body>
</html>